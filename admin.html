<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOMO å¾Œå°ç®¡ç†ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Admin specific overrides */
        body {
            padding: 2rem;
            /* Prevent pull-to-refresh on mobile while dragging */
            overscroll-behavior: none;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: rgb(2, 80, 119);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        /* Inputs are handled in styles.css generally, but ensuring overrides here if needed */


        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-label input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }

        /* é›™å±¤è¦æ ¼æ¨£å¼ */
        .variant-box {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background: #fdfdfd;
            margin-top: 10px;
        }

        .variant-header {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #666;
            font-weight: bold;
        }

        .variant-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .v-input-lg {
            flex: 2;
        }

        .v-input-sm {
            flex: 1;
        }

        .btn-add-variant {
            background: #27ae60;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-remove-variant {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-submit {
            background: rgb(2, 80, 119);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }

        .btn-submit:hover {
            background: var(--accent);
        }

        .btn-cancel {
            background: #7f8c8d;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            display: none;
        }

        .editing .btn-submit {
            background: #e67e22;
        }

        .editing .btn-submit::after {
            content: " (ç¢ºèªä¿®æ”¹)";
        }

        .product-list {
            margin-top: 3rem;
        }

        .product-item {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 1rem 0;
            gap: 1rem;
        }

        .product-img-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
        }

        .product-info {
            flex-grow: 1;
        }

        .action-btns {
            display: flex;
            gap: 10px;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        #imagePositionEditor {
            display: none;
            margin-top: 1rem;
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        #imagePositionEditor.active {
            display: block;
        }

        .pos-group-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .pos-edit-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }

        .pos-edit-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #ddd;
        }

        .pos-select-display {
            flex-grow: 1;
            padding: 8px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #555;
            cursor: pointer;
        }

        .btn-pos-edit {
            background: #8e44ad;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .pos-control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* âœ¨ åœ–ç‰‡ä½ç½®ç·¨è¼¯å™¨ Modal æ¨£å¼ âœ¨ */
        .pos-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
            text-align: center;
        }

        .pos-preview-container {
            width: 100%;
            height: 300px;
            background: #eee;
            border: 2px dashed #ccc;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            cursor: grab;
            touch-action: none;
            /* Prevent scroll while dragging */
        }

        .pos-preview-container:active {
            cursor: grabbing;
        }

        .pos-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: 50% 50%;
            /* Initial Default */
            pointer-events: none;
            /* Let container handle events */
        }

        /* Crosshair overlay */
        .pos-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
        }

        .pos-overlay::before,
        .pos-overlay::after {
            content: "";
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }

        .pos-overlay::before {
            width: 100%;
            height: 1px;
        }

        /* Horizontal line */
        .pos-overlay::after {
            width: 1px;
            height: 100%;
        }

        /* Vertical line */

        /* âœ¨ åœ–ç‰‡åº« Modal æ¨£å¼ âœ¨ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 70vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #aaa;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .gallery-item {
            position: relative;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 5px;
            overflow: hidden;
            aspect-ratio: 1/1;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item.selected {
            border-color: var(--accent);
        }

        .gallery-item.selected::after {
            content: "âœ”";
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            font-size: 14px;
            line-height: 20px;
        }

        .btn-gallery {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn-gallery-confirm {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            margin-top: 15px;
            width: 100%;
            cursor: pointer;
            font-size: 1rem;
        }

        /* âœ¨ åˆ†é ç±¤ (Tabs) æ¨£å¼ âœ¨ */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            font-weight: bold;
        }

        .tab-btn.active {
            color: rgb(2, 80, 119);
            border-bottom-color: rgb(2, 80, 119);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .gallery-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 10;
        }

        .gallery-delete-btn:hover {
            background: #c0392b;
        }
    </style>
</head>

<body>

    <div class="container" id="mainContainer">
        <h1 id="pageTitle">å¾Œå°ç®¡ç†ç³»çµ±</h1>

        <!-- âœ¨ åˆ†é ç±¤å°è¦½ âœ¨ -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-products')">ğŸ“¦ å•†å“ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('tab-orders')">ğŸ“ è¨‚å–®ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('tab-gallery')">ğŸ–¼ï¸ åœ–ç‰‡åº«ç®¡ç†</button>
        </div>

        <!-- âœ¨ 1. å•†å“ç®¡ç†åˆ†é  âœ¨ -->
        <div id="tab-products" class="tab-content active">
            <h2 id="formTitle" style="border-left:5px solid rgb(2, 80, 119); padding-left:10px;">æ–°å¢å•†å“</h2>

            <form id="uploadForm">
                <input type="hidden" id="editId">

                <div class="form-group">
                    <label>å•†å“åç¨±</label>
                    <input type="text" name="name" id="pName" required>
                </div>

                <div class="form-group">
                    <label>åŸºæœ¬åƒ¹æ ¼ (é¡¯ç¤ºç”¨)</label>
                    <input type="number" name="price" id="pPrice" required>
                </div>

                <div class="form-group">
                    <label>å¤šè¦æ ¼é¸é … (å¯è¨­å®šå–®å±¤æˆ–é›™å±¤)</label>
                    <div class="variant-box">
                        <div class="variant-header">
                            <span style="flex:2">è¦æ ¼ä¸€ (å¦‚:åŠŸèƒ½/é¡è‰²)</span>
                            <span style="flex:2">è¦æ ¼äºŒ (å¦‚:å¤§å°/å®¹é‡) *é¸å¡«</span>
                            <span style="flex:1">åƒ¹æ ¼</span>
                            <span style="width:45px"></span>
                        </div>
                        <div id="variantList"></div>
                        <button type="button" class="btn-add-variant" onclick="addVariantRow()">+ æ–°å¢è¦æ ¼</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>åˆ†é¡ (å¯è¤‡é¸)</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" name="category" value="æ´—é«®"> æ´—é«®</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="æŸ“é«®"> æŸ“é«®</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="ç‡™é«®"> ç‡™é«®</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="ä¿é¤Š"> ä¿é¤Š</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="ç…¥é‡‡"> ç…¥é‡‡</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="æ´»èƒ"> æ´»èƒ</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="R.O.8">
                            R.O.8</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="S.I.G">
                            S.I.G</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="æ—¥æœ¬"> æ—¥æœ¬</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="éŸ“åœ‹"> éŸ“åœ‹</label>
                        <label class="checkbox-label"><input type="checkbox" name="category" value="å…¶ä»–"> å…¶ä»–</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>å•†å“æè¿°</label>
                    <textarea name="description" id="pDesc" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>å•†å“åœ–ç‰‡ (æ–°ä¸Šå‚³ æˆ– å¾åœ–åº«é¸æ“‡)</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn-gallery" onclick="openGallery()">å¾åœ–åº«é¸æ“‡</button>
                        <input type="file" name="photos" id="fileInput" multiple accept="image/*"
                            onchange="previewFiles()" style="flex-grow: 1;">
                    </div>
                </div>

                <div id="imagePositionEditor">
                    <div id="positionTitle" class="pos-group-title">åœ–ç‰‡é è¦½èˆ‡ä½ç½®è¨­å®š</div>
                    <div id="positionList"></div>
                </div>

                <button type="submit" id="submitBtn" class="btn-submit">ç«‹å³ä¸Šæ¶</button>
                <button type="button" id="cancelBtn" class="btn-cancel" onclick="resetForm()">å–æ¶ˆç·¨è¼¯</button>
            </form>

            <hr style="margin: 3rem 0;">

            <h2>å·²ä¸Šæ¶å•†å“åˆ—è¡¨</h2>
            <div id="productList" class="product-list"></div>
        </div>

        <!-- âœ¨ 2. è¨‚å–®ç®¡ç†åˆ†é  âœ¨ -->
        <div id="tab-orders" class="tab-content">
            <h2>ğŸ“¦ è¨‚å–®åˆ—è¡¨</h2>
            <div id="orderList" class="product-list">è¼‰å…¥ä¸­...</div>
        </div>

        <!-- âœ¨ 3. åœ–ç‰‡åº«ç®¡ç†åˆ†é  âœ¨ -->
        <div id="tab-gallery" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>ğŸ–¼ï¸ åœ–ç‰‡åº«ç®¡ç†</h2>
                <button onclick="loadGalleryManager()" class="btn-gallery">é‡æ–°æ•´ç†</button>
            </div>
            <p style="color:#666; margin-bottom:1rem;">é€™è£¡é¡¯ç¤ºä¼ºæœå™¨ä¸Šçš„æ‰€æœ‰åœ–ç‰‡ã€‚æ‚¨å¯ä»¥åˆªé™¤ä¸å†ä½¿ç”¨çš„èˆŠåœ–ã€‚</p>
            <div id="galleryManagerGrid" class="gallery-grid">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div id="galleryModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeGallery()">&times;</span>
            <h2>é¸æ“‡ç¾æœ‰åœ–ç‰‡</h2>
            <div id="galleryGrid" class="gallery-grid">è¼‰å…¥ä¸­...</div>
            <button class="btn-gallery-confirm" onclick="confirmGallerySelection()">ç¢ºèªé¸æ“‡</button>
        </div>
    </div>

    <!-- âœ¨ è¦–è¦ºåŒ–ä½ç½®ç·¨è¼¯å™¨ Model âœ¨ -->
    <div id="posEditorModal" class="modal">
        <div class="pos-modal-content">
            <h2>èª¿æ•´åœ–ç‰‡é¡¯ç¤ºä½ç½®</h2>
            <p style="font-size:0.9rem; color:#666;">è«‹åœ¨ä¸‹æ–¹åœ–ç‰‡ä¸ŠæŒ‰ä½æ»‘é¼ æ‹–æ›³ï¼Œèª¿æ•´é¡¯ç¤ºé‡é»</p>

            <div class="pos-preview-container" id="posDragArea">
                <img src="" id="posPreviewImg" class="pos-preview-img">
                <div class="pos-overlay"></div>
            </div>

            <div style="margin-bottom: 20px; font-family: monospace;">
                ä½ç½®ï¼š<span id="posValueDisplay">50% 50%</span>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="rotationSlider" style="margin-bottom:10px;">æ—‹è½‰è§’åº¦ï¼š<span
                        id="rotValueDisplay">0Â°</span></label>
                <input type="range" id="rotationSlider" min="0" max="360" value="0" style="width: 80%;"
                    oninput="updateRotationPreview(this.value)">
                <button type="button" class="btn-pos-edit"
                    onclick="document.getElementById('rotationSlider').value=0; updateRotationPreview(0);"
                    style="margin-left: 10px; padding: 5px 10px;">é‡ç½®</button>
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn-submit" onclick="savePosition()"
                    style="width:auto; padding: 10px 30px;">ç¢ºèªå„²å­˜</button>
                <button class="btn-cancel" onclick="closePosEditor()"
                    style="display:inline-block; width:auto;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/products';
        const GALLERY_API = '/api/images';
        let allProducts = [];

        // âœ¨ æš«å­˜ä½¿ç”¨è€…é¸æ“‡çš„èˆŠåœ–ç‰‡ç¶²å€ âœ¨
        let selectedGalleryImages = [];

        // å…¨åŸŸè®Šæ•¸ï¼šè¿½è¹¤ç›®å‰æ­£åœ¨ç·¨è¼¯çš„ input æ¬„ä½
        let currentEditingInput = null;

        function addVariantRow(s1 = "", s2 = "", price = "") {
            const div = document.createElement('div');
            div.className = 'variant-row';
            div.innerHTML = `
            <input type="text" placeholder="ä¾‹å¦‚: ä¿æ¿•å‹" class="v-s1 v-input-lg" value="${s1}">
            <input type="text" placeholder="ä¾‹å¦‚: 300ml" class="v-s2 v-input-lg" value="${s2}">
            <input type="number" placeholder="åƒ¹æ ¼" class="v-price v-input-sm" value="${price}">
            <button type="button" class="btn-remove-variant" onclick="this.parentElement.remove()">åˆªé™¤</button>
        `;
            document.getElementById('variantList').appendChild(div);
        }

        async function loadProducts() {
            try {
                const res = await fetch(API_URL);
                allProducts = await res.json();
                const list = document.getElementById('productList');
                list.innerHTML = '';

                allProducts.forEach(p => {
                    let imgUrl = (p.images && p.images.length > 0) ? p.images[0] : 'https://placehold.co/100';
                    let catText = Array.isArray(p.category) ? p.category.join(', ') : p.category;
                    let variantHint = (p.variants && p.variants.length > 0) ? `<span style="color:blue; font-size:0.8rem;">(å¤šè¦æ ¼)</span>` : '';

                    list.innerHTML += `
                    <div class="product-item">
                        <img src="${imgUrl}" class="product-img-thumb" onerror="this.src='https://placehold.co/100'">
                        <div class="product-info">
                            <strong>${p.name} ${variantHint}</strong> <br>
                            <span style="color: #666; font-size: 0.9rem;">$${p.price} | ${catText}</span>
                        </div>
                        <div class="action-btns">
                            <button class="btn-edit" onclick="startEdit(${p.id})">ç·¨è¼¯</button>
                            <button class="btn-delete" onclick="deleteProduct(${p.id})">åˆªé™¤</button>
                        </div>
                    </div>
                `;
                });
            } catch (e) { console.error("è¼‰å…¥å¤±æ•—", e); }
        }

        // âœ¨ æ•´åˆé è¦½åŠŸèƒ½ï¼šæ··åˆã€Œæ–°ä¸Šå‚³æª”æ¡ˆã€èˆ‡ã€Œå·²é¸èˆŠåœ–ç‰‡ã€ âœ¨
        function previewFiles() {
            const fileInput = document.getElementById('fileInput');
            const posList = document.getElementById('positionList');
            const editor = document.getElementById('imagePositionEditor');
            const title = document.getElementById('positionTitle');
            posList.innerHTML = '';

            const hasFiles = fileInput.files && fileInput.files.length > 0;
            const hasGallery = selectedGalleryImages.length > 0;

            if (hasFiles || hasGallery) {
                editor.classList.add('active');
                title.innerText = "åœ–ç‰‡é è¦½èˆ‡ä½ç½®è¨­å®š (æ–°æª”æ¡ˆ + å·²é¸åœ–ç‰‡)";

                let totalIndex = 0;

                // 1. å…ˆé¡¯ç¤ºå‰›å‰›åœ¨åœ–åº«é¸çš„èˆŠåœ–
                selectedGalleryImages.forEach(imgUrl => {
                    const defaultPos = "50% 50%";
                    const defaultRot = 0;
                    posList.innerHTML += createPosEditRow(imgUrl, totalIndex + 1, defaultPos, defaultRot, '3498db', '[å·²é¸èˆŠåœ–]');
                    totalIndex++;
                });

                // 2. å†é¡¯ç¤ºæ–°ä¸Šå‚³çš„æª”æ¡ˆ
                if (hasFiles) {
                    Array.from(fileInput.files).forEach((file) => {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const defaultPos = "50% 50%";
                            const defaultRot = 0;
                            // æ³¨æ„ï¼šæ–°æª”æ¡ˆçš„ name å±¬æ€§æ˜¯ filenameï¼Œé€™è£¡æˆ‘å€‘åªç”¨æ–¼é¡¯ç¤º
                            posList.innerHTML += createPosEditRow(e.target.result, file.name, defaultPos, defaultRot, '27ae60', '[æ–°ä¸Šå‚³]');
                        }
                        reader.readAsDataURL(file);
                    });
                }

            } else {
                const editId = document.getElementById('editId').value;
                if (!editId) editor.classList.remove('active');
            }
        }

        // âœ¨ åœ–åº«ç›¸é—œåŠŸèƒ½ âœ¨
        async function openGallery() {
            document.getElementById('galleryModal').style.display = 'block';
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = 'è¼‰å…¥ä¸­...';

            try {
                const res = await fetch(GALLERY_API);
                const images = await res.json();
                grid.innerHTML = '';

                if (images.length === 0) {
                    grid.innerHTML = '<p>ä¼ºæœå™¨å°šç„¡åœ–ç‰‡ï¼Œè«‹å…ˆä¸Šå‚³ã€‚</p>';
                    return;
                }

                images.forEach(imgUrl => {
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    // å¦‚æœä¹‹å‰å·²ç¶“é¸éé€™å¼µï¼ŒåŠ ä¸Š selected æ¨£å¼
                    if (selectedGalleryImages.includes(imgUrl)) div.classList.add('selected');

                    div.innerHTML = `<img src="${imgUrl}">`;
                    div.onclick = () => {
                        div.classList.toggle('selected');
                    };
                    grid.appendChild(div);
                });

            } catch (e) {
                console.error(e);
                grid.innerHTML = '<p style="color:red">ç„¡æ³•è¼‰å…¥åœ–ç‰‡åº«</p>';
            }
        }

        function closeGallery() {
            document.getElementById('galleryModal').style.display = 'none';
        }

        function confirmGallerySelection() {
            // æ”¶é›†æ‰€æœ‰è¢«é¸ä¸­çš„åœ–ç‰‡
            const selectedItems = document.querySelectorAll('.gallery-item.selected img');
            selectedGalleryImages = Array.from(selectedItems).map(img => img.src);

            closeGallery();
            previewFiles(); // æ›´æ–°é è¦½å€
        }

        // é»æ“Š Modal å¤–åœé—œé–‰
        window.onclick = function (event) {
            const modal = document.getElementById('galleryModal');
            if (event.target == modal) closeGallery();
        }

        // --- ç·¨è¼¯åŠŸèƒ½ ---
        function startEdit(id) {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;

            document.getElementById('editId').value = product.id;
            document.getElementById('pName').value = product.name;
            document.getElementById('pPrice').value = product.price;
            document.getElementById('pDesc').value = product.description;

            // âœ¨ ä¿®æ­£åˆ†é¡å‹¾é¸é‚è¼¯ âœ¨
            // å…ˆå…¨éƒ¨å–æ¶ˆå‹¾é¸
            document.querySelectorAll('input[name="category"]').forEach(cb => cb.checked = false);

            // ç¢ºä¿ product.category æ˜¯ä¸€å€‹é™£åˆ— (å¾Œç«¯ç¾åœ¨æœƒçµ±ä¸€å›å‚³é™£åˆ—äº†)
            let cats = product.category;
            if (!Array.isArray(cats)) cats = [cats]; // é˜²å‘†ï¼šå¦‚æœæ˜¯èˆŠå­—ä¸²ï¼Œè½‰æˆé™£åˆ—

            // ä¾åºå‹¾é¸
            cats.forEach(cat => {
                const cb = document.querySelector(`input[name="category"][value="${cat}"]`);
                if (cb) cb.checked = true;
            });

            // ... (ä»¥ä¸‹æ˜¯è¦æ ¼å’Œåœ–ç‰‡çš„èˆŠæœ‰ç¨‹å¼ç¢¼ï¼Œä¿æŒä¸è®Š) ...
            document.getElementById('variantList').innerHTML = '';
            if (product.variants && product.variants.length > 0) {
                product.variants.forEach(v => {
                    if (v.s1) addVariantRow(v.s1, v.s2 || "", v.price);
                    else if (v.name) addVariantRow(v.name, "", v.price);
                });
            }

            document.getElementById('formTitle').innerText = "ç·¨è¼¯å•†å“";
            document.getElementById('submitBtn').innerText = "ç¢ºèªä¿®æ”¹";
            document.getElementById('cancelBtn').style.display = "block";
            document.getElementById('mainContainer').classList.add('editing');

            // ... (åœ–ç‰‡é è¦½é‚è¼¯ä¿æŒä¸è®Š) ...
            selectedGalleryImages = product.images || [];
            document.getElementById('fileInput').value = "";

            const posList = document.getElementById('positionList');
            const editor = document.getElementById('imagePositionEditor');
            posList.innerHTML = '';
            editor.classList.add('active');
            document.getElementById('positionTitle').innerText = "ç¾æœ‰åœ–ç‰‡ (å¯æ–°å¢/åˆªé™¤)";

            if (selectedGalleryImages.length > 0) {
                selectedGalleryImages.forEach((imgUrl, index) => {
                    // å¦‚æœå¾Œç«¯å‚³ä¾†çš„ä¸æ˜¯ % æ ¼å¼ï¼Œéœ€è¦è½‰ä¸€ä¸‹å—ï¼Ÿç›®å‰å‡è¨­å¾Œç«¯å­˜çš„å·²ç¶“æ˜¯å­—ä¸²
                    let currentPos = (product.image_positions && product.image_positions[index]) || '50% 50%';
                    let currentRot = (product.image_rotations && product.image_rotations[index]) || 0;

                    // èˆŠè³‡æ–™ç›¸å®¹ï¼šå¦‚æœæœ‰ "center center" é€™ç¨®æ ¼å¼ï¼Œè½‰æˆ %
                    const mapping = {
                        'center center': '50% 50%', 'top center': '50% 0%', 'bottom center': '50% 100%',
                        'center left': '0% 50%', 'center right': '100% 50%', 'top left': '0% 0%', 'top right': '100% 0%'
                    };
                    if (mapping[currentPos]) currentPos = mapping[currentPos];

                    posList.innerHTML += createPosEditRow(imgUrl, index + 1, currentPos, currentRot, 'f39c12', '[åŸåœ–ç‰‡]');
                });
            } else { posList.innerHTML = '<p style="padding:10px">ç„¡åœ–ç‰‡</p>'; }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function resetForm() {
            document.getElementById('uploadForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('variantList').innerHTML = "";
            document.getElementById('positionList').innerHTML = "";
            document.getElementById('imagePositionEditor').classList.remove('active');
            document.getElementById('formTitle').innerText = "æ–°å¢å•†å“";
            document.getElementById('submitBtn').innerText = "ç«‹å³ä¸Šæ¶";
            document.getElementById('cancelBtn').style.display = "none";
            document.getElementById('mainContainer').classList.remove('editing');
            selectedGalleryImages = []; // æ¸…ç©ºå·²é¸èˆŠåœ–
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            const editId = document.getElementById('editId').value;
            const formData = new FormData(e.target);
            const url = editId ? `${API_URL}/${editId}` : API_URL;
            const method = editId ? 'PUT' : 'POST';

            // é›™å±¤è¦æ ¼
            const variants = [];
            document.querySelectorAll('.variant-row').forEach(row => {
                const vS1 = row.querySelector('.v-s1').value.trim();
                const vS2 = row.querySelector('.v-s2').value.trim();
                const vPrice = row.querySelector('.v-price').value.trim();
                if (vS1 && vPrice) {
                    variants.push({ s1: vS1, s2: vS2, price: parseInt(vPrice) });
                }
            });
            formData.append('variants', JSON.stringify(variants));

            // âœ¨ é—œéµï¼šå°‡ä½¿ç”¨è€…åœ¨åœ–åº«é¸çš„åœ–ç‰‡ç¶²å€ï¼Œappend åˆ° formData âœ¨
            selectedGalleryImages.forEach(imgUrl => {
                formData.append('existing_images', imgUrl);
            });

            try {
                const res = await fetch(url, { method: method, body: formData });
                if (res.ok) {
                    alert(editId ? 'å•†å“ä¿®æ”¹æˆåŠŸï¼' : 'å•†å“ä¸Šæ¶æˆåŠŸï¼');
                    resetForm(); loadProducts();
                } else { alert('æ“ä½œå¤±æ•—'); }
            } catch (err) { console.error(err); alert('ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨'); }
            btn.disabled = false;
        });

        async function deleteProduct(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ')) return;
            try { await fetch(`${API_URL}/${id}`, { method: 'DELETE' }); loadProducts(); }
            catch (err) { alert('åˆªé™¤å¤±æ•—'); }
        }

        // âœ¨ è¨‚å–®åˆ—è¡¨åŠŸèƒ½ âœ¨
        async function loadOrders() {
            const orderList = document.getElementById('orderList');
            try {
                const res = await fetch('/api/orders');
                const orders = await res.json();

                if (orders.length === 0) {
                    orderList.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">ç›®å‰æ²’æœ‰è¨‚å–®</p>';
                    return;
                }

                orderList.innerHTML = '';
                orders.forEach(order => {
                    // è§£æè¨‚å–®å•†å“
                    let itemsHtml = '';
                    if (order.order_data && order.order_data.length > 0) {
                        itemsHtml = order.order_data.map(item =>
                            `${item.name} ${item.variant ? '(' + item.variant + ')' : ''} x${item.quantity}`
                        ).join('<br>');
                    }

                    orderList.innerHTML += `
                        <div class="product-item" style="flex-wrap: wrap;">
                            <div style="flex-grow: 1;">
                                <strong style="color: var(--accent);">è¨‚å–® #${order.id}</strong> - ${order.customer_name}<br>
                                <span style="color: #666; font-size: 0.9rem;">${itemsHtml}</span>
                            </div>
                            <div style="text-align: right; min-width: 150px;">
                                <strong style="color: #27ae60;">NT$ ${order.total_amount.toLocaleString()}</strong><br>
                                <span style="font-size: 0.8rem; color: #999;">${order.created_at}</span>
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                console.error("è¼‰å…¥è¨‚å–®å¤±æ•—", e);
                orderList.innerHTML = '<p style="color: red;">è¼‰å…¥è¨‚å–®å¤±æ•—</p>';
            }
        }

        loadProducts();
        loadOrders();

        // ==========================================
        // âœ¨ æ–°å¢å‡½æ•¸ï¼šç”¢ç”Ÿä½ç½®ç·¨è¼¯åˆ— HTML âœ¨
        // ==========================================
        function createPosEditRow(imgUrl, labelInfo, currentPos, currentRot, color, typeLabel) {
            // Encode imgUrl to avoid breaking HTML if it contains special chars
            // But for blob URLs or local paths it's usually safe. 
            // We use a unique ID for the input to reference it later if needed, but simple passing logic is fine.
            return `
            <div class="pos-edit-item" style="border-left: 5px solid #${color};">
                <img src="${imgUrl}" class="pos-edit-img">
                <div style="flex-grow:1">
                    <label style="font-size:0.9rem; color:#${color};">${typeLabel} åœ–ç‰‡ ${labelInfo}ï¼š</label>
                    <div class="pos-control-row">
                        <!-- ä½ç½®è¼¸å…¥ (éš±è—) -->
                        <input type="hidden" name="positions" value="${currentPos}">
                        <!-- æ—‹è½‰è¼¸å…¥ (éš±è—) -->
                        <input type="hidden" name="rotations" value="${currentRot}">
                        
                        <!-- é¡¯ç¤ºç‹€æ…‹ -->
                        <div class="pos-select-display" onclick="openPosEditor('${imgUrl}', this.parentElement)">
                            ä½ç½®: ${currentPos} | æ—‹è½‰: ${currentRot}Â°
                        </div>
                        
                        <button type="button" class="btn-pos-edit" onclick="openPosEditor('${imgUrl}', this.parentElement)">èª¿æ•´</button>
                    </div>
                </div>
            </div>
            `;
        }

        // ==========================================
        // âœ¨ è¦–è¦ºåŒ–æ‹–æ›³ç·¨è¼¯é‚è¼¯ (Visual Drag Editor) âœ¨
        // ==========================================
        let isDragging = false;
        let startX, startY;
        let currentXPct = 50;
        let currentYPct = 50;
        let currentRotation = 0; // âœ¨ æ–°å¢æ—‹è½‰è®Šæ•¸

        const posDragArea = document.getElementById('posDragArea');
        const posPreviewImg = document.getElementById('posPreviewImg');
        const posValueDisplay = document.getElementById('posValueDisplay');
        const rotValueDisplay = document.getElementById('rotValueDisplay');
        const rotationSlider = document.getElementById('rotationSlider');

        // Note: inputEl now refers to the CONTAINER (.pos-control-row)
        let currentEditingRow = null;

        function openPosEditor(imgSrc, controlRow) {
            currentEditingRow = controlRow;
            posPreviewImg.src = imgSrc;
            document.getElementById('posEditorModal').style.display = 'block';

            const posInput = controlRow.querySelector('input[name="positions"]');
            const rotInput = controlRow.querySelector('input[name="rotations"]');

            // Parse Pos
            const val = posInput.value || "50% 50%";
            const parts = val.split(' ');
            if (parts.length === 2) {
                currentXPct = parseFloat(parts[0]);
                currentYPct = parseFloat(parts[1]);
            } else {
                currentXPct = 50;
                currentYPct = 50;
            }

            // Parse Rot
            currentRotation = parseInt(rotInput.value) || 0;
            rotationSlider.value = currentRotation;

            updatePreview();
        }

        function closePosEditor() {
            document.getElementById('posEditorModal').style.display = 'none';
        }

        function savePosition() {
            if (currentEditingRow) {
                const posInput = currentEditingRow.querySelector('input[name="positions"]');
                const rotInput = currentEditingRow.querySelector('input[name="rotations"]');
                const displayDiv = currentEditingRow.querySelector('.pos-select-display');

                const newPos = `${currentXPct.toFixed(1)}% ${currentYPct.toFixed(1)}%`;
                const newRot = currentRotation;

                posInput.value = newPos;
                rotInput.value = newRot;
                displayDiv.innerText = `ä½ç½®: ${newPos} | æ—‹è½‰: ${newRot}Â°`;
            }
            closePosEditor();
        }

        function updateRotationPreview(val) {
            currentRotation = parseInt(val);
            updatePreview();
        }

        function updatePreview() {
            // Update CSS
            posPreviewImg.style.objectPosition = `${currentXPct}% ${currentYPct}%`;
            posPreviewImg.style.transform = `rotate(${currentRotation}deg)`; // âœ¨ Apply Rotation

            // Update Text
            posValueDisplay.innerText = `${currentXPct.toFixed(0)}% ${currentYPct.toFixed(0)}%`;
            rotValueDisplay.innerText = `${currentRotation}Â°`;
        }

        // --- Drag Event Listeners ---
        // Mouse Events
        if (posDragArea) {
            posDragArea.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
            });

            window.addEventListener('mouseup', () => { isDragging = false; });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                handleDrag(e.clientX, e.clientY);
            });

            // Touch Events
            posDragArea.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                e.preventDefault(); // Stop scroll
            });

            window.addEventListener('touchend', () => { isDragging = false; });

            window.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                handleDrag(e.touches[0].clientX, e.touches[0].clientY);
            });
        }

        function handleDrag(clientX, clientY) {
            // Sensibility factor
            const sensitivity = 0.5;
            const deltaX = clientX - startX;
            const deltaY = clientY - startY;

            // Update start pos for next frame
            startX = clientX;
            startY = clientY;

            // Update Percentages
            currentXPct += deltaX * sensitivity;
            currentYPct += deltaY * sensitivity;

            // Clamp 0-100
            if (currentXPct < 0) currentXPct = 0;
            if (currentXPct > 100) currentXPct = 100;
            if (currentYPct < 0) currentYPct = 0;
            if (currentYPct > 100) currentYPct = 100;

            updatePreview();
        }

        // ==========================================
        // âœ¨ åˆ†é ç±¤åˆ‡æ›èˆ‡åœ–ç‰‡åº«ç®¡ç† JS âœ¨
        // ==========================================
        function switchTab(tabId) {
            // 1. åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 2. åˆ‡æ›å…§å®¹é¡¯ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            // 3. ç‰¹æ®Šè™•ç†ï¼šå¦‚æœæ˜¯åœ–ç‰‡åº« Tabï¼Œè‡ªå‹•è¼‰å…¥
            if (tabId === 'tab-gallery') {
                loadGalleryManager();
            }
        }

        async function loadGalleryManager() {
            const grid = document.getElementById('galleryManagerGrid');
            grid.innerHTML = 'è¼‰å…¥ä¸­...';
            try {
                const res = await fetch(GALLERY_API);
                const images = await res.json();
                grid.innerHTML = '';

                if (images.length === 0) {
                    grid.innerHTML = '<p>ç›®å‰æ²’æœ‰ä»»ä½•åœ–ç‰‡</p>';
                    return;
                }

                images.forEach(imgUrl => {
                    // Extract filename for display/delete
                    const filename = imgUrl.split('/').pop();

                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    div.style.cursor = "default"; // Manager mode doesn't select

                    div.innerHTML = `
                        <img src="${imgUrl}" onclick="window.open('${imgUrl}', '_blank')">
                        <button class="gallery-delete-btn" onclick="deleteImage('${filename}')" title="åˆªé™¤åœ–ç‰‡">Ã—</button>
                    `;
                    grid.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                grid.innerHTML = '<p style="color:red">ç„¡æ³•è¼‰å…¥åœ–ç‰‡</p>';
            }
        }

        async function deleteImage(filename) {
            if (!confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤åœ–ç‰‡ "${filename}" å—ï¼Ÿ\n(æ³¨æ„ï¼šå¦‚æœæœ‰å•†å“æ­£åœ¨ä½¿ç”¨æ­¤åœ–ï¼Œåœ–ç‰‡å°‡æœƒå¤±æ•ˆ)`)) return;

            try {
                // DELETE /api/images?filename=xxx
                const res = await fetch(`${GALLERY_API}?filename=${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                const result = await res.json();

                if (res.ok) {
                    // Refresh gallery
                    loadGalleryManager();
                } else {
                    alert('åˆªé™¤å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                console.error(e);
                alert('ç„¡æ³•é€£ç·šä¼ºæœå™¨');
            }
        }

    </script>
</body>

</html>